<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Trading Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2rem;
            color: white;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .status-stopped {
            background: #f44336;
        }

        .status-idle {
            background: #ff9800;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.85rem;
            color: #fff;
        }
        .badge-ok { background: #4CAF50; }
        .badge-warn { background: #ff9800; }
        .badge-err { background: #f44336; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #da190b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .portfolio-table th,
        .portfolio-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .portfolio-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .portfolio-table tr:hover {
            background: #f8f9fa;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: 420px; /* keep the chart visible on one screen */
            overflow: hidden;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 20px;
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Automated Trading Dashboard</h1>
            <p>Fully automated portfolio management with real-time monitoring</p>
            
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(135deg, #2196F3, #1976D2);">‚öôÔ∏è</div>
                <h2 class="card-title">Trading Controls</h2>
            </div>
            
            <div id="status-display">
                <p><span class="status-indicator status-idle"></span>Status: <span id="trading-status">Idle</span></p>
                <p>Last Update: <span id="last-update">Never</span></p>
                <p>System Health: <span id="health-badge" class="badge badge-warn">Checking‚Ä¶</span></p>
            </div>
            
            <div class="control-buttons">
                <button id="start-btn" class="btn btn-primary">
                    <span id="start-text">üöÄ Start Automated Trading</span>
                </button>
                <button id="stop-btn" class="btn btn-danger" style="display: none;">
                    üõë Stop Trading
                </button>
                <button id="refresh-btn" class="btn btn-secondary">
                    üîÑ Refresh Data
                </button>
                <a href="/configure" class="btn btn-secondary">‚öôÔ∏è Configure</a>
            </div>
            
            <div id="alert-container"></div>
        </div>

        <!-- Dashboard Metrics -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #4CAF50, #45a049);">üí∞</div>
                    <h3 class="card-title">Total Equity</h3>
                </div>
                <div class="metric-value" id="total-equity">$0.00</div>
                <div class="metric-label">Portfolio + Cash Balance</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #2196F3, #1976D2);">üíµ</div>
                    <h3 class="card-title">Cash Balance</h3>
                </div>
                <div class="metric-value" id="cash-balance">$0.00</div>
                <div class="metric-label">Available for Trading</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #FF9800, #F57C00);">üìà</div>
                    <h3 class="card-title">Daily P&L</h3>
                </div>
                <div class="metric-value" id="daily-pnl">$0.00</div>
                <div class="metric-label">Today's Profit/Loss</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">üìä</div>
                    <h3 class="card-title">Max Drawdown</h3>
                </div>
                <div class="metric-value" id="max-drawdown">0.00%</div>
                <div class="metric-label">Peak to Trough</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="portfolio">Portfolio</button>
            <button class="nav-tab" data-tab="performance">Performance</button>
            <button class="nav-tab" data-tab="trades">Trade History</button>
            <button class="nav-tab" data-tab="autotrade">Auto-Trading</button>
        </div>

        <!-- Portfolio Tab -->
        <div id="portfolio-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #4CAF50, #45a049);">üìã</div>
                    <h3 class="card-title">Current Holdings</h3>
                </div>
                <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
                    <div class="form-group" style="min-width:160px;">
                        <label for="pos-ticker">Ticker</label>
                        <input id="pos-ticker" class="form-control" placeholder="SPY" />
                    </div>
                    <div class="form-group" style="min-width:160px;">
                        <label for="pos-shares">Shares</label>
                        <input id="pos-shares" type="number" class="form-control" step="1" min="1" placeholder="10" />
                    </div>
                    <div class="form-group" style="min-width:160px;">
                        <label for="pos-buy">Buy Price</label>
                        <input id="pos-buy" type="number" class="form-control" step="0.01" min="0" placeholder="450" />
                    </div>
                    <div class="form-group" style="min-width:160px;">
                        <label for="pos-stop">Stop Loss (optional)</label>
                        <input id="pos-stop" type="number" class="form-control" step="0.01" min="0" placeholder="0" />
                    </div>
                    {% if not auto_trade_only %}
                    <button id="pos-add" class="btn btn-primary">‚ûï Add Position</button>
                    {% else %}
                    <div class="alert alert-info" style="margin:0;">Manual adds disabled. AI manages holdings. Change universe in Auto-Trading.</div>
                    {% endif %}
                </div>
                <div id="portfolio-content">
                    <p>Loading portfolio data...</p>
                </div>
            </div>
        </div>

        <!-- Performance Tab -->
        <div id="performance-tab" class="tab-content">
            <div class="chart-container">
                <h3 class="chart-title">Portfolio Performance Over Time</h3>
                <div style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn btn-secondary" id="range-1M">1M</button>
                    <button class="btn btn-secondary" id="range-3M">3M</button>
                    <button class="btn btn-secondary" id="range-6M">6M</button>
                    <button class="btn btn-secondary" id="range-1Y">1Y</button>
                    <button class="btn btn-secondary" id="range-YTD">YTD</button>
                    <button class="btn btn-secondary" id="range-ALL">All</button>
                </div>
                <canvas id="performance-chart" style="width:100%; height:100%;"></canvas>
                <div id="performance-dates" style="margin-top:8px; color:#666; font-size:0.9rem;"></div>
            </div>
        </div>

        <!-- Trade History Tab -->
        <div id="trades-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #FF9800, #F57C00);">üìù</div>
                    <h3 class="card-title">Recent Trades</h3>
                </div>
                <div id="trades-content">
                    <p>Loading trade history...</p>
                </div>
            </div>
        </div>

        <!-- Auto-Trading Tab -->
        <div id="autotrade-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #00bcd4, #0097a7);">ü§ñ</div>
                    <h3 class="card-title">Auto-Trading</h3>
                </div>
                <div class="form-group">
                    <label>Universe (comma-separated tickers)</label>
                    <input id="auto-universe" class="form-control" placeholder="SPY,IWM,QQQ,XBI" />
                </div>
                <div class="form-group">
                    <label>Max Positions</label>
                    <input id="auto-max" type="number" class="form-control" value="5" min="1" max="20" />
                </div>
                <div class="form-group">
                    <label>Per-Trade Cash %</label>
                    <input id="auto-cashpct" type="number" class="form-control" value="20" min="5" max="100" />
                </div>
                <div class="form-group">
                    <label>Stop-Loss %</label>
                    <input id="auto-stoppct" type="number" class="form-control" value="10" min="1" max="50" />
                </div>
                <div class="form-group">
                    <label>Daily Strategy Prompt</label>
                    <textarea id="auto-prompt" class="form-control" rows="4" placeholder="Describe your daily strategy and constraints..."></textarea>
                </div>
                <div class="button-group">
                    <button id="auto-save" class="btn btn-primary">üíæ Save Config</button>
                    <button id="auto-run" class="btn btn-secondary">ü§ñ Run Auto-Trade Once</button>
                    <button id="ai-run" class="btn btn-secondary">üß† Run AI Strategy</button>
                </div>
                <div id="auto-result" style="margin-top:12px;"></div>
                <hr style="margin:20px 0;" />
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #4CAF50, #45a049);">‚è±Ô∏è</div>
                    <h3 class="card-title">Auto-Run Scheduler</h3>
                </div>
                <div class="form-group">
                    <label>Enable Auto-Run</label>
                    <input type="checkbox" id="sched-enabled" />
                </div>
                <div class="form-group">
                    <label>Interval Minutes</label>
                    <input id="sched-interval" type="number" class="form-control" value="15" min="1" max="120" />
                </div>
                <div class="form-group">
                    <label>Only During Market Hours (ET)</label>
                    <input type="checkbox" id="sched-market" checked />
                </div>
                <div class="button-group">
                    <button id="sched-save" class="btn btn-primary">‚úÖ Apply Schedule</button>
                    <button id="sched-refresh" class="btn btn-secondary">üîÑ Refresh Status</button>
                </div>
                <div id="sched-status" style="margin-top:12px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Global variables
        let performanceChart = null;
        let fullHistoryData = [];
        let chartRange = '6M';
        let isTrading = false;

        // DOM elements
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const tradingStatus = document.getElementById('trading-status');
        const lastUpdate = document.getElementById('last-update');
        const alertContainer = document.getElementById('alert-container');

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setupEventListeners();
            setupTabNavigation();
            refreshHealth();
            setInterval(refreshHealth, 30000);
        });

        // Socket.IO event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('trading_update', function(data) {
            updateTradingStatus(data);
            showAlert('Trading completed successfully!', 'success');
        });

        socket.on('trading_error', function(data) {
            showAlert('Trading error: ' + data.error, 'error');
            updateTradingStatus({is_running: false});
        });

        socket.on('status', function(data) {
            updateTradingStatus(data);
        });

        function setupEventListeners() {
            startBtn.addEventListener('click', startTrading);
            stopBtn.addEventListener('click', stopTrading);
            refreshBtn.addEventListener('click', loadDashboardData);
        }

        async function refreshHealth() {
            const badge = document.getElementById('health-badge');
            try {
                const res = await axios.get('/healthz');
                if (res.status === 200 && res.data.status === 'ok') {
                    badge.textContent = 'OK';
                    badge.className = 'badge badge-ok';
                } else {
                    badge.textContent = 'Attention';
                    badge.className = 'badge badge-warn';
                }
            } catch (e) {
                badge.textContent = 'Error';
                badge.className = 'badge badge-err';
            }
        }

        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');
                    
                    // Load specific tab data
                    if (targetTab === 'performance') {
                        loadPerformanceChart();
                    } else if (targetTab === 'trades') {
                        loadTradeHistory();
                    }
                    if (targetTab === 'autotrade') {
                        loadAutoConfig();
                    }
                });
            });
        }

        async function startTrading() {
            try {
                startBtn.disabled = true;
                startBtn.innerHTML = '<span class="loading"></span>Starting...';
                
                const response = await axios.post('/start_trading');
                
                if (response.data.status === 'success') {
                    showAlert('Automated trading started!', 'success');
                    updateTradingStatus({is_running: true});
                    await loadDashboardData();
                } else {
                    showAlert(response.data.message || 'Trading failed', 'error');
                }
            } catch (error) {
                const msg = (error && error.response && error.response.data && error.response.data.message) ? error.response.data.message : error.message;
                showAlert('Error starting trading: ' + msg, 'error');
            } finally {
                startBtn.disabled = false;
                startBtn.innerHTML = 'üöÄ Start Automated Trading';
            }
        }

        async function stopTrading() {
            try {
                const response = await axios.post('/stop_trading');
                
                if (response.data.status === 'success') {
                    showAlert('Trading stopped!', 'info');
                    updateTradingStatus({is_running: false});
                }
            } catch (error) {
                showAlert('Error stopping trading: ' + error.message, 'error');
            }
        }

        async function loadDashboardData() {
            try {
                const [portfolioResponse, historyResponse] = await Promise.all([
                    axios.get('/get_portfolio'),
                    axios.get('/get_history')
                ]);

                updatePortfolioDisplay(portfolioResponse.data);
                updateMetrics(portfolioResponse.data);
                
                if (historyResponse.data.length > 0) {
                    fullHistoryData = historyResponse.data;
                    updatePerformanceChart(fullHistoryData);
                }
            } catch (error) {
                showAlert('Error loading dashboard data: ' + error.message, 'error');
            }
        }

        function updatePortfolioDisplay(data) {
            const portfolioContent = document.getElementById('portfolio-content');
            
            if (!data.portfolio || data.portfolio.length === 0) {
                portfolioContent.innerHTML = '<p>No holdings in portfolio. Start trading to see positions.</p>';
                return;
            }

            let html = `
                <table class="portfolio-table">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Shares</th>
                            <th>Buy Price</th>
                            <th>Cost Basis</th>
                            <th>Stop Loss</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.portfolio.forEach(stock => {
                html += `
                    <tr>
                        <td><strong>${stock.ticker}</strong></td>
                        <td>${stock.shares}</td>
                        <td>$${parseFloat(stock.buy_price).toFixed(2)}</td>
                        <td>$${parseFloat(stock.cost_basis).toFixed(2)}</td>
                        <td>${stock.stop_loss ? '$' + parseFloat(stock.stop_loss).toFixed(2) : 'None'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            portfolioContent.innerHTML = html;
        }

        function updateMetrics(data) {
            document.getElementById('total-equity').textContent = '$' + data.total_equity.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('cash-balance').textContent = '$' + data.cash.toLocaleString('en-US', {minimumFractionDigits: 2});
        }

        function updateTradingStatus(data) {
            isTrading = data.is_running;
            
            if (data.is_running) {
                tradingStatus.textContent = 'Running';
                tradingStatus.className = 'status-indicator status-running';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
            } else {
                tradingStatus.textContent = 'Stopped';
                tradingStatus.className = 'status-indicator status-stopped';
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }

            if (data.last_update) {
                lastUpdate.textContent = new Date(data.last_update).toLocaleString();
            }

            if (data.current_portfolio) {
                updatePortfolioDisplay({
                    portfolio: data.current_portfolio,
                    cash: data.cash_balance,
                    total_equity: data.total_equity
                });
                updateMetrics({
                    portfolio: data.current_portfolio,
                    cash: data.cash_balance,
                    total_equity: data.total_equity
                });
            }
        }

        function getRangedHistory(data, rangeKey) {
            if (!data || data.length === 0) return [];

            const today = new Date();
            const toTs = (d) => new Date(d).getTime();
            if (rangeKey === 'ALL') return data;
            if (rangeKey === 'YTD') {
                const jan1 = new Date(today.getFullYear(), 0, 1).getTime();
                return data.filter(x => toTs(x.date) >= jan1);
            }
            const map = { '1M': 22, '3M': 66, '6M': 132, '1Y': 252 };
            const n = map[rangeKey] || 132;
            return data.slice(-n);
        }

        function updatePerformanceChart(historyData) {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }

            // Apply selected range and decimate to improve readability
            const dataSlice = getRangedHistory(historyData, chartRange);
            const MAX_POINTS = Math.min(300, Math.max(60, dataSlice.length));

            const labels = dataSlice.map(item => item.date);
            const equityData = dataSlice.map(item => item.equity);
            const cashData = dataSlice.map(item => item.cash);

            // Show From/To date stamps below the chart
            const datesEl = document.getElementById('performance-dates');
            if (datesEl) {
                const from = labels[0];
                const to = labels[labels.length - 1];
                datesEl.textContent = labels.length > 1 ? `From ${from} to ${to}  ‚Ä¢  ${labels.length} points` : '';
            }

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Equity',
                        data: equityData,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Cash Balance',
                        data: cashData,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Portfolio Performance'
                        },
                        decimation: { enabled: true, algorithm: 'lttb', samples: MAX_POINTS }
                    },
                    scales: {
                        x: {
                            grid: { drawOnChartArea: false },
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 20,
                                padding: 6,
                                maxRotation: 0,
                                callback: function(value, index, ticks) {
                                    const lbl = labels[index] || '';
                                    // Show every tick label as YYYY-MM or MM/DD depending on range
                                    try {
                                        const d = new Date(lbl);
                                        if (chartRange === '1M' || chartRange === '3M') {
                                            return (d.getMonth()+1) + '/' + d.getDate();
                                        }
                                        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
                                    } catch { return lbl; }
                                }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    const n = Number(value);
                                    return '$' + (isFinite(n) ? n.toLocaleString() : value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function loadPerformanceChart() {
            axios.get('/get_history')
                .then(response => {
                    if (response.data.length > 0) {
                        fullHistoryData = response.data;
                        updatePerformanceChart(fullHistoryData);
                    }
                })
                .catch(error => {
                    console.error('Error loading performance data:', error);
                });
        }

        // Range buttons
        document.addEventListener('DOMContentLoaded', function() {
            const ranges = ['1M','3M','6M','1Y','YTD','ALL'];
            ranges.forEach(r => {
                const el = document.getElementById('range-' + r);
                if (el) {
                    el.addEventListener('click', () => {
                        chartRange = r;
                        updatePerformanceChart(fullHistoryData);
                    });
                }
            });
        });

        function loadTradeHistory() {
            // This would load trade log data
            const tradesContent = document.getElementById('trades-content');
            tradesContent.innerHTML = '<p>Trade history will be displayed here. Check the trade log CSV file for detailed records.</p>';
        }

        async function loadAutoConfig() {
            try {
                const res = await axios.get('/autotrade/config');
                const cfg = res.data;
                document.getElementById('auto-universe').value = (cfg.universe || []).join(',');
                document.getElementById('auto-max').value = cfg.max_positions || 5;
                document.getElementById('auto-cashpct').value = Math.round((cfg.per_trade_cash_pct || 0.2) * 100);
                document.getElementById('auto-stoppct').value = Math.round((cfg.stop_loss_pct || 0.1) * 100);
                document.getElementById('auto-prompt').value = cfg.prompt || '';
            } catch (e) { console.error(e); }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('auto-save').addEventListener('click', async () => {
                try {
                    const body = {
                        universe: document.getElementById('auto-universe').value,
                        max_positions: parseInt(document.getElementById('auto-max').value) || 5,
                        per_trade_cash_pct: (parseFloat(document.getElementById('auto-cashpct').value) || 20) / 100,
                        stop_loss_pct: (parseFloat(document.getElementById('auto-stoppct').value) || 10) / 100,
                        prompt: document.getElementById('auto-prompt').value || ''
                    };
                    const res = await axios.post('/autotrade/config', body);
                    showAlert('Auto-trade config saved', 'success');
                } catch (e) {
                    showAlert('Failed to save auto-trade config', 'error');
                }
            });
            document.getElementById('ai-run').addEventListener('click', async () => {
                try {
                    const res = await axios.post('/autotrade/ai_run');
                    if (res.data.status === 'success') {
                        document.getElementById('auto-result').textContent = `AI Plan: ${JSON.stringify(res.data.plan)}`;
                        loadDashboardData();
                        showAlert('AI strategy executed', 'success');
                    } else {
                        showAlert(res.data.message || 'AI run failed', 'error');
                    }
                } catch (e) {
                    const msg = e?.response?.data?.message || e.message;
                    showAlert('AI run error: ' + msg, 'error');
                }
            });
            document.getElementById('auto-run').addEventListener('click', async () => {
                try {
                    const res = await axios.post('/autotrade/run');
                    const out = res.data;
                    document.getElementById('auto-result').textContent = `Executed: ${JSON.stringify(out.executed || [])}`;
                    // refresh metrics/portfolio
                    loadDashboardData();
                    showAlert('Auto-trade run completed', 'success');
                } catch (e) {
                    showAlert('Auto-trade failed: ' + (e?.response?.data?.message || e.message), 'error');
                }
            });
            // Scheduler handlers
            document.getElementById('sched-save').addEventListener('click', async () => {
                try {
                    const body = {
                        enabled: document.getElementById('sched-enabled').checked,
                        interval_minutes: parseInt(document.getElementById('sched-interval').value) || 15,
                        market_hours_only: document.getElementById('sched-market').checked,
                    };
                    const res = await axios.post('/autotrade/schedule', body);
                    document.getElementById('sched-status').textContent = `Enabled: ${res.data.enabled} | Interval: ${res.data.interval_minutes}m | Market hours only: ${res.data.market_hours_only}`;
                    showAlert('Schedule applied', 'success');
                } catch (e) {
                    showAlert('Failed to apply schedule', 'error');
                }
            });
            document.getElementById('sched-refresh').addEventListener('click', async () => {
                try {
                    const res = await axios.get('/autotrade/schedule');
                    const d = res.data;
                    document.getElementById('sched-enabled').checked = !!d.enabled;
                    document.getElementById('sched-interval').value = d.interval_minutes || 15;
                    document.getElementById('sched-market').checked = !!d.market_hours_only;
                    document.getElementById('sched-status').textContent = `Enabled: ${d.enabled} | Interval: ${d.interval_minutes}m | Market hours only: ${d.market_hours_only} | Running: ${d.running}`;
                } catch (e) { console.error(e); }
            });
            // Add position
            document.getElementById('pos-add').addEventListener('click', async () => {
                try {
                    const body = {
                        ticker: document.getElementById('pos-ticker').value,
                        shares: parseFloat(document.getElementById('pos-shares').value),
                        buy_price: parseFloat(document.getElementById('pos-buy').value),
                        stop_loss: parseFloat(document.getElementById('pos-stop').value || '0')
                    };
                    const res = await axios.post('/positions/add', body);
                    if (res.data.status === 'success') {
                        showAlert('Position added', 'success');
                        updatePortfolioDisplay({
                            portfolio: res.data.portfolio,
                            cash: res.data.cash,
                            total_equity: res.data.total_equity
                        });
                        updateMetrics({
                            portfolio: res.data.portfolio,
                            cash: res.data.cash,
                            total_equity: res.data.total_equity
                        });
                    } else {
                        showAlert(res.data.message || 'Failed to add position', 'error');
                    }
                } catch (e) {
                    const msg = e?.response?.data?.message || e.message;
                    showAlert('Error adding position: ' + msg, 'error');
                }
            });
        });

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>
